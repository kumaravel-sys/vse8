<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>School ShareMarket (Demo)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{--bg:#061020;--card:#0c1722;--accent:#08c36a;--muted:#98a5b3;color-scheme:dark}
    *{box-sizing:border-box;font-family:Inter,Arial,Helvetica,sans-serif}
    body{margin:0;background:var(--bg);color:#e9f4f8}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .brand{font-weight:700}
    .container{max-width:1100px;margin:24px auto;padding:12px}
    .card{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .stock-card{padding:12px;border-radius:10px;background:linear-gradient(0deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
    input,select,button,textarea{font-size:14px}
    input,select,textarea{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;width:100%}
    button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#04211a;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse}
    td,th{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:600px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="brand">School ShareMarket — Demo</div>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="muted">Bg</div>
      <input id="bgColor" type="color" value="#061020" title="background color" />
      <div id="userShort" class="muted"></div>
    </div>
  </header>

  <div class="container">
    <!-- AUTH VIEW -->
    <div id="authView" class="card">
      <h2 id="authTitle">Welcome — Sign up or Log in</h2>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button id="showSignup">Sign up</button>
        <button id="showLogin">Log in</button>
      </div>

      <div id="signupForm" class="hidden">
        <label>Full name</label>
        <input id="suName" placeholder="Full name">
        <label>Email (school id)</label>
        <input id="suEmail" type="email" placeholder="student1@school.com">
        <label>Password (6+ chars)</label>
        <input id="suPass" type="password">
        <div style="margin-top:10px"><button id="doSignup">Create Demat Account</button></div>
        <div class="muted" style="margin-top:6px">Starting virtual balance: ₹100,000</div>
      </div>

      <div id="loginForm" class="hidden">
        <label>Email</label>
        <input id="liEmail" type="email">
        <label>Password</label>
        <input id="liPass" type="password">
        <div style="margin-top:10px"><button id="doLogin">Log in</button></div>
        <div class="muted" style="margin-top:6px">If you are admin, login with your admin email.</div>
      </div>

      <div id="authMsg" class="muted" style="margin-top:10px"></div>
    </div>

    <!-- APP VIEW (hidden until login) -->
    <div id="appView" class="hidden">
      <div class="card row" style="justify-content:space-between;align-items:center">
        <div>
          <h3 id="welcome">Hi —</h3>
          <div class="muted">Balance: ₹<span id="balance">0</span> | Net worth: ₹<span id="networth">0</span></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnAdmin" class="hidden">Admin Panel</button>
          <button id="btnLogout">Logout</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:14px">
        <div>
          <div class="card">
            <h4>Market — Click a stock for chart & trade</h4>
            <div id="stockGrid" class="grid" style="margin-top:12px"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h4>Quick Trade</h4>
            <div style="display:flex;gap:8px">
              <select id="quickSelect"></select>
              <input id="quickQty" type="number" value="1" min="1" style="width:110px">
              <button id="quickBuy">Buy</button>
              <button id="quickSell">Sell</button>
            </div>
            <div id="tradeMsg" class="muted" style="margin-top:8px"></div>
          </div>
        </div>

        <div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div id="selectedTitle" style="font-weight:600">Select a stock</div>
                <div id="selectedSym" class="muted">---</div>
              </div>
              <div>
                <select id="chartRange"><option value="D">1M</option><option value="W">6M</option><option value="M">1Y</option><option value="Y">Max</option></select>
              </div>
            </div>
            <div style="height:260px;margin-top:12px"><canvas id="chartCanvas"></canvas></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h4>Your Portfolio</h4>
            <div id="portfolio" class="muted">Loading...</div>
          </div>

          <div id="financials" class="card" style="margin-top:12px;display:none">
            <h4>Company info & fundamentals</h4>
            <div id="companyInfo" class="muted"></div>
          </div>

          <div id="adminPanel" class="card hidden" style="margin-top:12px">
            <h4>Admin — Users</h4>
            <div id="adminUsers">Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- BUY/SELL Modal -->
    <div id="tradeModal" class="hidden" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:200">
      <div class="card" style="width:420px">
        <h3 id="modalTitle">Trade</h3>
        <div class="muted" id="modalSymbol"></div>
        <label>Price (live)</label><input id="modalPrice" disabled>
        <label>Quantity</label><input id="modalQty" type="number" min="1" value="1">
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="modalBuy">Buy</button>
          <button id="modalSell">Sell</button>
          <button id="modalClose">Cancel</button>
        </div>
        <div id="modalMsg" class="muted" style="margin-top:8px"></div>
      </div>
    </div>

  </div>

<script>
/***** ========== CONFIG - REQUIRED (replace before deploy) ========== *****/
const firebaseConfig = {
  apiKey: "AIzaSyBa_fJN3xt6dias0bBa5dSxYMFtWWH39IA",
  authDomain: "school-stock-website.firebaseapp.com",
  projectId: "school-stock-website",
  storageBucket: "school-stock-website.firebasestorage.app",
  messagingSenderId: "9711095333",
  appId: "1:9711095333:web:f90d4ecd1c93308b7979cc"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
    // Finnhub key (paste your key)
    const FINNHUB_KEY = 'd3bm7n1r01qqg7bv706gd3bm7n1r01qqg7bv7070';

    // Admin email for admin functions (change to your admin email)
    const ADMIN_EMAIL = 'admin6@vse.com';

    /***** END CONFIG *****/

    // default stocks list (will be copied into Firestore 'config/stocks' if missing)
    const DEFAULT_STOCKS = [
      {symbol:'RELIANCE.NS', name:'ORGANISING DEPARTMENT'},
      {symbol:'TCS.NS', name:'TECH DEPARTMENT'},
      {symbol:'INFY.NS', name:'MODELS DEPARTMENT'},
      {symbol:'HDFCBANK.NS', name:'FINANCE DEPARTMENT'},
      {symbol:'ICICIBANK.NS', name:'FOODSTALL DEPARTMENT'},
      {symbol:'SBIN.NS', name:'STALLS DEPARTMENT'},
      {symbol:'HINDUNILVR.NS', name:'GAMES DEPARTMENT'},
      {symbol:'BHARTIARTL.NS', name:'PHOTOGRAPHY DEPARTMENT'},
      {symbol:'LT.NS', name:'SEMINAR DEPARTMENT'}
    ];

/* ------------------ initialize Firebase (compat free client SDK won't be used) ------------------ */
const script1 = document.createElement('script');
script1.src = "https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js";
document.head.appendChild(script1);
const script2 = document.createElement('script');
script2.src = "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js";
document.head.appendChild(script2);
const script3 = document.createElement('script');
script3.src = "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js";
document.head.appendChild(script3);

/* ---- run when firebase compat scripts loaded ---- */
script3.onload = () => {
  firebase.initializeApp(FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // UI shortcuts
  const $ = s => document.querySelector(s);
  const stockGrid = $('#stockGrid');
  const quickSelect = $('#quickSelect');
  const chartCanvas = document.getElementById('chartCanvas').getContext('2d');
  let chartInstance = null;

  let appStocks = DEFAULT_STOCKS.slice();
  let currentUser = null;
  let currentUserDoc = null;
  let selectedSymbol = null;

  // UI events
  $('#showSignup').addEventListener('click', ()=>{ $('#signupForm').classList.toggle('hidden'); $('#loginForm').classList.add('hidden'); $('#authTitle').textContent='Create Demat Account'; });
  $('#showLogin').addEventListener('click', ()=>{ $('#loginForm').classList.toggle('hidden'); $('#signupForm').classList.add('hidden'); $('#authTitle').textContent='Login to Demat Account'; });

  $('#doSignup').addEventListener('click', async ()=>{
    const name = $('#suName').value.trim(), email = $('#suEmail').value.trim(), pass = $('#suPass').value;
    if(!name||!email||!pass){ $('#authMsg').textContent = 'Fill all fields'; return; }
    try{
      const cu = await auth.createUserWithEmailAndPassword(email, pass);
      const uid = cu.user.uid;
      await db.collection('users').doc(uid).set({ name, email, balance:100000, holdings:{}, transactions:[], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      $('#authMsg').textContent = 'Account created. You are signed in.';
    }catch(e){ console.error(e); $('#authMsg').textContent = 'Error: '+e.message; }
  });

  $('#doLogin').addEventListener('click', async ()=>{
    const email = $('#liEmail').value.trim(), pass = $('#liPass').value;
    if(!email||!pass){ $('#authMsg').textContent='Enter email & password'; return; }
    try{ await auth.signInWithEmailAndPassword(email, pass); }catch(e){ $('#authMsg').textContent = 'Login error: '+e.message; }
  });

  $('#btnLogout').addEventListener('click', ()=> auth.signOut());
  $('#bgColor').addEventListener('input', e=> document.body.style.background = e.target.value);

  // Quick trade buttons
  $('#quickBuy').addEventListener('click', ()=> {
    const sym = quickSelect.value; openTradeModal(sym,'buy');
  });
  $('#quickSell').addEventListener('click', ()=> {
    const sym = quickSelect.value; openTradeModal(sym,'sell');
  });

  // modal controls
  $('#modalClose').addEventListener('click', ()=> $('#tradeModal').classList.add('hidden'));
  $('#modalBuy').addEventListener('click', ()=> doTrade('buy'));
  $('#modalSell').addEventListener('click', ()=> doTrade('sell'));
  $('#chartRange').addEventListener('change', ()=> { if(selectedSymbol) drawChart(selectedSymbol, $('#chartRange').value); });

  // auth state
  auth.onAuthStateChanged(async user => {
    if(user){
      currentUser = user;
      $('#authView').classList.add('hidden'); $('#appView').classList.remove('hidden');
      $('#userShort').textContent = user.email;
      await ensureConfig(); // loads config/stocks doc or creates default
      await ensureUserDoc(user);
      await renderMarket();
      await refreshPortfolio();
      // admin UI visibility
      if(user.email === ADMIN_EMAIL){ $('#btnAdmin').classList.remove('hidden'); $('#adminPanel').classList.remove('hidden'); loadAdminUsers(); } else { $('#btnAdmin').classList.add('hidden'); $('#adminPanel').classList.add('hidden'); }
    } else {
      currentUser = null;
      $('#authView').classList.remove('hidden'); $('#appView').classList.add('hidden'); $('#userShort').textContent = '';
    }
  });

  // ensure config doc exists
  async function ensureConfig(){
    const docRef = db.collection('config').doc('stocks');
    const snap = await docRef.get();
    if(!snap.exists){
      await docRef.set({ list: DEFAULT_STOCKS });
      appStocks = DEFAULT_STOCKS.slice();
    } else {
      appStocks = snap.data().list || DEFAULT_STOCKS.slice();
    }
  }

  // ensure user doc exists
  async function ensureUserDoc(user){
    const uref = db.collection('users').doc(user.uid);
    const s = await uref.get();
    if(!s.exists) await uref.set({ name: user.displayName||'', email: user.email, balance:100000, holdings:{}, transactions:[], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    currentUserDoc = (await uref.get()).data();
  }

  // render market cards
  async function renderMarket(){
    stockGrid.innerHTML = ''; quickSelect.innerHTML = '';
    for(const s of appStocks){
      const card = document.createElement('div'); card.className = 'card stock-card';
      card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${s.name}</strong><div class="muted">${s.symbol}</div></div><div class="muted" style="text-align:right"><div data-price>–</div><div data-change></div></div></div>
        <div style="margin-top:10px;display:flex;gap:8px"><button data-sym="${s.symbol}" class="viewBtn">View</button><button data-sym="${s.symbol}" class="buyBtn">Buy</button><button data-sym="${s.symbol}" class="sellBtn">Sell</button></div>`;
      stockGrid.appendChild(card);

      quickSelect.innerHTML += `<option value="${s.symbol}">${s.name} (${s.symbol})</option>`;

      // fetch price
      (async function(card,sym){
        const q = await fetchQuote(sym);
        const priceEl = card.querySelector('[data-price]'); const changeEl = card.querySelector('[data-change]');
        if(q && q.c !== undefined){
          priceEl.textContent = '₹'+q.c.toFixed(2);
          const ch = q.d; const chp = q.dp;
          changeEl.innerHTML = `<span style="color:${ch>=0?'#3ee27a':'#ff7b7b'}">${ch>=0? '▲':'▼'} ${ch.toFixed(2)} (${chp.toFixed(2)}%)</span>`;
        } else priceEl.textContent = 'N/A';
      })(card,s.symbol);

      // event bindings
      card.querySelector('.viewBtn').addEventListener('click', ()=> { selectSymbol(s.symbol, s.name); });
      card.querySelector('.buyBtn').addEventListener('click', ()=> openTradeModal(s.symbol,'buy'));
      card.querySelector('.sellBtn').addEventListener('click', ()=> openTradeModal(s.symbol,'sell'));
    }
  }

  // fetch quote
  async function fetchQuote(symbol){
    try{
      const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${FINNHUB_KEY}`);
      return await res.json();
    }catch(e){ console.error(e); return null; }
  }

  // draw chart using candle API (resolution param: D,W,M,Y)
  async function drawChart(symbol, range){
    $('#selectedTitle').textContent = 'Loading chart...';
    $('#selectedSym').textContent = symbol;
    $('#financials').style.display = 'none';
    const now = Math.floor(Date.now()/1000);
    let from;
    if(range === 'D') from = now - 30*24*3600; // 1 month
    if(range === 'W') from = now - 180*24*3600; // 6 months
    if(range === 'M') from = now - 365*24*3600;
    if(range === 'Y') from = now - 3650*24*3600;
    const res = await fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${encodeURIComponent(symbol)}&resolution=D&from=${from}&to=${now}&token=${FINNHUB_KEY}`);
    const data = await res.json();
    if(!data || data.s !== 'ok'){ $('#selectedTitle').textContent = symbol + ' (no chart)'; return; }
    const labels = data.t.map(ts => new Date(ts*1000).toLocaleDateString());
    const closes = data.c;
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(chartCanvas, { type:'line', data:{ labels, datasets:[{ label: symbol, data: closes, fill:true }]}, options:{responsive:true,maintainAspectRatio:false}});
    $('#selectedTitle').textContent = (appStocks.find(x=>x.symbol===symbol)?.name || symbol);
    // load company info
    loadCompanyInfo(symbol);
  }

  // show company profile + basic fundamentals (fetched from Finnhub)
  async function loadCompanyInfo(symbol){
    try{
      const profR = await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${encodeURIComponent(symbol)}&token=${FINNHUB_KEY}`);
      const prof = await profR.json();
      const finR = await fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${encodeURIComponent(symbol)}&metric=all&token=${FINNHUB_KEY}`);
      const fin = await finR.json();
      $('#companyInfo').innerHTML = `<div><strong>${prof.name||symbol}</strong> (${prof.ticker||''})<div class="muted">${prof.finnhubIndustry || ''}</div></div>
        <div style="margin-top:8px">Market Cap: ${prof.marketCapitalization? '₹'+ (prof.marketCapitalization*1).toLocaleString() : 'N/A'}</div>
        <div style="margin-top:6px">PE ratio (ttm): ${fin.metric?.peNormalizedAnnual || 'N/A'}</div>
        <div style="margin-top:6px">${prof.weburl ? `<a href="${prof.weburl}" target="_blank">Company site</a>`:''}</div>`;
      $('#financials').style.display = 'block';
    }catch(e){ console.warn('company info error',e); $('#companyInfo').textContent = 'No company info available'; $('#financials').style.display = 'block'; }
  }

  // when user selects symbol
  function selectSymbol(sym, name){
    selectedSymbol = sym;
    $('#chartRange').value = 'D';
    drawChart(sym, 'D');
  }

  // open trade modal
  async function openTradeModal(symbol, mode){
    $('#tradeModal').classList.remove('hidden');
    $('#modalTitle').textContent = `${mode==='buy'?'Buy':'Sell'} ${symbol}`;
    $('#modalSymbol').textContent = symbol;
    const q = await fetchQuote(symbol);
    $('#modalPrice').value = q && q.c ? q.c.toFixed(2) : '0';
    $('#modalQty').value = 1;
    $('#modalMsg').textContent = '';
    $('#modalBuy').style.display = mode==='buy'?'inline-block':'none';
    $('#modalSell').style.display = mode==='sell'?'inline-block':'none';
    // store context
    window._tradeCtx = { symbol, mode };
  }

  // perform trade using transaction
  async function doTrade(mode){
    if(!currentUser) return alert('Not signed in');
    const qty = Number($('#modalQty').value); if(qty<=0){ $('#modalMsg').textContent='Invalid qty'; return; }
    const price = Number($('#modalPrice').value); if(price<=0){ $('#modalMsg').textContent='Invalid price'; return; }
    const symbol = window._tradeCtx.symbol;
    const userRef = db.collection('users').doc(currentUser.uid);
    try{
      await db.runTransaction(async tx => {
        const ud = (await tx.get(userRef)).data();
        if(!ud) throw 'User not found';
        if(mode === 'buy'){
          const cost = qty*price;
          if((ud.balance||0) < cost) throw 'Insufficient balance';
          const newBalance = (ud.balance||0) - cost;
          const newQty = (ud.holdings && ud.holdings[symbol]) ? ud.holdings[symbol] + qty : qty;
          const trans = { type:'buy', symbol, qty, price, time: firebase.firestore.FieldValue.serverTimestamp() };
          tx.update(userRef, { balance: newBalance, [`holdings.${symbol}`]: newQty, transactions: firebase.firestore.FieldValue.arrayUnion(trans) });
        } else {
          const owned = (ud.holdings && ud.holdings[symbol]) || 0;
          if(owned < qty) throw 'Not enough shares';
          const newQty = owned - qty;
          const newBalance = (ud.balance||0) + qty*price;
          const trans = { type:'sell', symbol, qty, price, time: firebase.firestore.FieldValue.serverTimestamp() };
          const updates = { balance: newBalance, transactions: firebase.firestore.FieldValue.arrayUnion(trans) };
          if(newQty>0) updates[`holdings.${symbol}`] = newQty; else updates[`holdings.${symbol}`] = firebase.firestore.FieldValue.delete();
          tx.update(userRef, updates);
        }
      });
      $('#modalMsg').textContent = mode==='buy'?'Bought!':'Sold!';
      $('#tradeModal').classList.add('hidden');
      await refreshPortfolio();
    }catch(e){ console.error(e); $('#modalMsg').textContent = 'Error: '+(e.message||e); }
  }

  // refresh portfolio view & net worth
  async function refreshPortfolio(){
    if(!currentUser) return;
    const uref = db.collection('users').doc(currentUser.uid);
    const snap = await uref.get(); currentUserDoc = snap.data();
    $('#welcome').textContent = `Hi — ${currentUserDoc.name || currentUserDoc.email}`;
    $('#balance').textContent = Number(currentUserDoc.balance||0).toFixed(2);

    // compute holdings current value
    const holdings = currentUserDoc.holdings || {};
    let totalHoldVal = 0;
    const rows = [];
    for(const sym of Object.keys(holdings)){
      const qty = holdings[sym];
      const q = await fetchQuote(sym);
      const price = (q && q.c) ? q.c : 0;
      const value = price * qty;
      totalHoldVal += value;
      rows.push({ sym, qty, price, value });
    }
    $('#networth').textContent = (Number(currentUserDoc.balance||0) + totalHoldVal).toFixed(2);

    // render portfolio
    const pa = $('#portfolio');
    if(rows.length===0) pa.innerHTML = '<div class="muted">No holdings</div>';
    else {
      const table = document.createElement('table');
      table.innerHTML = `<tr><th>Symbol</th><th>Qty</th><th>Price</th><th>Value</th></tr>`;
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.sym}</td><td>${r.qty}</td><td>₹${Number(r.price).toFixed(2)}</td><td>₹${Number(r.value).toFixed(2)}</td>`;
        table.appendChild(tr);
      }
      pa.innerHTML = ''; pa.appendChild(table);
    }
  }

  // admin: list users
  async function loadAdminUsers(){
    if(!currentUser || currentUser.email !== ADMIN_EMAIL) return;
    const q = await db.collection('users').get();
    const container = $('#adminUsers'); container.innerHTML = '';
    q.forEach(doc => {
      const d = doc.data();
      const div = document.createElement('div'); div.style.marginBottom='8px';
      div.innerHTML = `<strong>${d.name||d.email}</strong> (${d.email}) - Balance: ₹${(d.balance||0).toFixed(2)} <button data-uid="${doc.id}">View</button>`;
      container.appendChild(div);
      div.querySelector('button').addEventListener('click', ()=> viewUser(doc.id));
    });
  }
  async function viewUser(uid){
    const doc = await db.collection('users').doc(uid).get();
    alert(JSON.stringify(doc.data(),null,2));
  }

  // initialize periodic refresh
  setInterval(async ()=> {
    if(currentUser) {
      // update small prices in cards
      const cards = document.querySelectorAll('.stock-card');
      for(const card of cards){
        const sym = card.querySelector('.muted')?.textContent || null; // not perfect but prices already loaded on render
      }
      await refreshPortfolio();
    }
  }, 60_000);

  // admin button opens the admin panel (optionally admin can edit default stocks document)
  $('#btnAdmin').addEventListener('click', async ()=>{
    if(!currentUser || currentUser.email !== ADMIN_EMAIL) return alert('Not allowed');
    // show a simple edit prompt to replace stock list (comma-separated symbol:name pairs)
    const text = prompt('Edit stocks as symbol:name separated by commas (example: RELIANCE.NS:Reliance,TCS.NS:TCS ...)', appStocks.map(s=>`${s.symbol}:${s.name}`).join(','));
    if(!text) return;
    try{
      const pairs = text.split(',').map(p=>p.trim()).filter(Boolean).map(p=>{
        const [sym,name] = p.split(':').map(x=>x.trim());
        return { symbol: sym, name: name||sym };
      });
      await db.collection('config').doc('stocks').set({ list: pairs });
      await ensureConfig();
      await renderMarket();
      alert('Stock list updated');
    }catch(e){ alert('Error: '+e.message); }
  });

  // helper: openTradeModal from quick actions
  window.openTradeModal = openTradeModal;

  // initial: nothing until auth state triggers
}; // end script3.onload

</script>
</body>
</html>
